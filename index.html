<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UNO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #111;
      color: #fff;
      padding: 1rem;
    }
    h1, h2 { text-align: center; }
    input {
      text-align: center;
      width: 50px;
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      border: none;
    }
    select, button {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.25rem;
      border-radius: 8px;
      border: none;
    }
    button { background: #333; color: white; }
    .player-setup, { margin: 1rem 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.5rem;
      text-align: center;
      width: 1%;
    }
    .winner { background: #224422; }
    .edit-btn { cursor: pointer; color: #0af; margin-left: 5px; }
    .scroll-container { overflow-x: auto; }
    .centered { text-align: center; margin-top: 2rem; }
    .active-cell {
      background-color: #333 !important;
    }
    #confirmDialog {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #confirmBox {
      background: #222;
      padding: 2rem;
      border-radius: 10px;
      text-align: center;
    }
    #confirmBox button { margin: 1rem; }
  </style>
</head>
<body>
  <h1>UNO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
  <p style="text-align:center;font-size:0.9rem">–î–∞–±–ª—Ç–∞–ø –ø–æ —ñ–º–µ–Ω—ñ ‚Äî –æ–±—Ä–∞—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è</p>

  <div id="setup">
    <label>–û–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ (2 ... 10): <input type="number" id="playerCount" min="2" max="10" value="4"></label>
    <div id="names"></div>
    <label>–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –æ—á–∫—ñ–≤:
      <select id="mode">
        <option value="300">–ó–∞—Ä—É–±–∞ –¥–æ 300 (–∫–æ–∂–µ–Ω –æ—Ç—Ä–∏–º—É—î —Å–≤–æ—ó –æ—á–∫–∏)</option>
        <option value="500">–°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–æ 500 (–ø–µ—Ä–µ–º–æ–∂–µ—Ü—å —Ä–∞—É–Ω–¥—É –æ—Ç—Ä–∏–º—É—î —Å—É–º—É –æ—á–∫—ñ–≤ —Å—É–ø–µ—Ä–Ω–∏–∫—ñ–≤)</option>
      </select>
    </label>
    <div class="centered">
      <button id="startBtn" onclick="startGame()">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
    </div>
  </div>

  <div id="game" style="display:none">
    <h2>...</h2>
    <div class="scroll-container">
      <table id="scoreTable"></table>
    </div>
    <div id="result"></div>
    
    <form id="roundForm" onsubmit="addRound(event)">
      <div id="roundInputs"></div>
      <button type="submit">–î–æ–¥–∞—Ç–∏ —Ä–∞—É–Ω–¥</button>
    </form>
    
    <div class="centered">
      <button onclick="confirmRestart()">–ù–æ–≤–∞ –≥—Ä–∞ –∑ —Ç–∏–º–∏ –∂ –≥—Ä–∞–≤—Ü—è–º–∏</button>
      <button onclick="confirmFullRestart()">–ù–æ–≤–∞ –≥—Ä–∞ (–æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ)</button>
    </div>

    <div id="confirmDialog">
      <div id="confirmBox">
        <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ—á–∞—Ç–∏ –Ω–æ–≤—É –≥—Ä—É?</p>
        <button onclick="doRestart()">–¢–ê–ö</button>
        <button onclick="cancelRestart()">–ù–Ü</button>
      </div>
    </div>
  </div>

  <script>
    let players = [];
    let scores = [];
    let mode = "300";
    let stars = [];
    let editIndex = null;
    let startPlayerIndex = null;

    function saveState() {
      localStorage.setItem("uno_state", JSON.stringify({ players, scores, mode, startPlayerIndex }));
    }

    function loadState() {
      const saved = localStorage.getItem("uno_state");
      if (saved) {
        const state = JSON.parse(saved);
        players = state.players || [];
        scores = state.scores || [];
        mode = state.mode || "500";
        startPlayerIndex = state.startPlayerIndex ?? null;
        if (players.length) {
          document.getElementById("setup").style.display = "none";
          document.getElementById("game").style.display = "block";
          renderRoundInputs();
          renderTable();
        }
      }
    }

    function startGame() {
      const count = +document.getElementById("playerCount").value;
      players = [];
      for (let i = 0; i < count; i++) {
        const name = document.getElementById("name_" + i).value || `–ì—Ä–∞–≤–µ—Ü—å ${i + 1}`;
        players.push(name);
      }
      mode = document.getElementById("mode").value;
      scores = [];
      startPlayerIndex = null;
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      renderRoundInputs();
      renderTable();
      saveState();
    }

    function renderNameInputs() {
      const count = +document.getElementById("playerCount").value;
      const container = document.getElementById("names");
      container.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const div = document.createElement("div");
        const input = document.createElement("input");
        input.placeholder = `–ì—Ä–∞–≤–µ—Ü—å ${i + 1}`;
        input.id = "name_" + i;
        div.appendChild(input);
        container.appendChild(div);
      }
    }

    document.getElementById("playerCount").addEventListener("input", renderNameInputs);
    renderNameInputs();
    loadState();

    function renderRoundInputs() {
      const container = document.getElementById("roundInputs");
      container.innerHTML = "";

      const table = document.createElement("table");
      table.style.marginTop = "1rem";

      const headRow = document.createElement("tr");
      players.forEach(p => {
        const th = document.createElement("th");
        th.textContent = p;
        table.appendChild(th);
        headRow.appendChild(th);
      });
      table.appendChild(headRow);

      const inputRow = document.createElement("tr");
      players.forEach((_, i) => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "tel";
        input.inputMode = "numeric";
        input.pattern = "-?[0-9]*";
        input.placeholder = "–û—á–∫–∏";
        input.id = `score_${i}`;
        input.className = "round-input";
        td.appendChild(input);
        inputRow.appendChild(td);
      });
      table.appendChild(inputRow);

      container.appendChild(document.createTextNode("..."));
      container.appendChild(document.createElement("br"));
      container.appendChild(table);
    }

    function addRound(e) {
      e.preventDefault();
      let round = [];
      let winnerIndexes = [];

      for (let i = 0; i < players.length; i++) {
        const val = document.getElementById(`score_${i}`).value.trim();
        if (val === "-" || val === "") {
          winnerIndexes.push(i);
        }
      }

      if (winnerIndexes.length !== 1) {
        alert("–ú–∞—î –±—É—Ç–∏ —Ä—ñ–≤–Ω–æ –æ–¥–∏–Ω –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å (–∑–∞–ª–∏—à–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—î –ø–æ–ª–µ –∞–±–æ '-')");
        return;
      }

      const winner = winnerIndexes[0];

      if (mode === "500") {
        let sum = 0;
        for (let i = 0; i < players.length; i++) {
          const val = document.getElementById(`score_${i}`).value.trim();
          if (i !== winner) {
            const num = parseInt(val);
            if (!isNaN(num)) sum += num;
          }
        }
        for (let i = 0; i < players.length; i++) {
          round[i] = i === winner ? sum : 0;
        }
      } else {
        for (let i = 0; i < players.length; i++) {
          const val = document.getElementById(`score_${i}`).value.trim();
          round[i] = (i === winner) ? 0 : parseInt(val) || 0;
        }
      }

      const roundObj = { scores: round, winner };

      if (editIndex !== null) {
        scores[editIndex] = roundObj;
        editIndex = null;
      } else {
        scores.push(roundObj);
      }

      renderTable();
      renderRoundInputs();
      saveState();
    }

    function isStarEntry(roundIdx, playerIdx) {
      const roundObj = scores[roundIdx];
      return roundObj.winner === playerIdx;
    }

    function setStartPlayer(index) {
      startPlayerIndex = index;
      saveState();
      renderTable();
    }

    function renderTable() {
      const table = document.getElementById("scoreTable");
      table.innerHTML = "";

      const starsPerPlayer = Array(players.length).fill(0);
      const header = document.createElement("tr");
      const goatIndexes = getGoatIndexes();

      header.innerHTML = `<th>–†–∞—É–Ω–¥</th>` + players.map((p, i) =>
        `<th ondblclick="setStartPlayer(${i})">${p} ${goatIndexes.includes(i) ? 'üêê' : ''}</th>`
      ).join("");
      table.appendChild(header);

      scores.forEach((roundObj, idx) => {
        const row = roundObj.scores;
        const tr = document.createElement("tr");
        const currentPlayerIndex = (startPlayerIndex !== null) ? (startPlayerIndex + idx) % players.length : null;

        const cells = row.map((val, i) => {
          const isStar = isStarEntry(idx, i);
          const isActive = i === currentPlayerIndex;
          if (isStar) starsPerPlayer[i]++;
          return `<td class="${isActive ? 'active-cell' : ''}">${isStar ? '‚≠ê' : val}</td>`;
        });

        tr.innerHTML = `<td>${idx + 1}<span class="edit-btn" onclick="editRound(${idx})">‚úèÔ∏è</span></td>` + cells.join("");
        table.appendChild(tr);
      });

      const totalRow = document.createElement("tr");
      totalRow.innerHTML = `<td><strong>–°—É–º–∞</strong></td>` + players.map((_, i) => {
        const sum = scores.reduce((a, r) => a + r.scores[i], 0);
        return `<td><strong>${sum}</strong></td>`;
      }).join("");
      table.appendChild(totalRow);

      stars = starsPerPlayer;
      checkWinner();
    }

    function getGoatIndexes() {
      const starCounts = players.map((_, i) => {
        return scores.reduce((count, _, roundIdx) => {
          return count + (isStarEntry(roundIdx, i) ? 1 : 0);
        }, 0);
      });

      const maxStars = Math.max(...starCounts);
      return starCounts.reduce((arr, count, i) => {
        if (count === maxStars && maxStars > 0) arr.push(i);
        return arr;
      }, []);
    }

    function checkWinner() {
      const totals = players.map((_, i) => scores.reduce((a, r) => a + r.scores[i], 0));
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (mode === "500") {
        const winnerIndexes = totals.map((t, i) => t >= 500 ? i : -1).filter(i => i !== -1);
        if (winnerIndexes.length) {
          resultDiv.innerHTML = winnerIndexes.map(i => `<h2>üèÜ ${players[i]} –ø–µ—Ä–µ–º—ñ–≥!</h2>`).join("");
        }
      } else {
        const loserIndexes = totals.map((t, i) => t >= 300 ? i : -1).filter(i => i !== -1);
        if (loserIndexes.length) {
          resultDiv.innerHTML = loserIndexes.map(i => `<h2>üíÄ ${players[i]} –ø—Ä–æ–≥—Ä–∞–≤!</h2>`).join("");
        }
      }
    }

    function editRound(index) {
      const roundObj = scores[index];
      players.forEach((p, i) => {
        const isWinner = roundObj.winner === i;
        document.getElementById(`score_${i}`).value = isWinner ? "" : roundObj.scores[i];
      });
      editIndex = index;
    }

    function confirmRestart() {
      document.getElementById("confirmDialog").style.display = "flex";
      document.getElementById("confirmBox").dataset.type = "soft";
    }

    function confirmFullRestart() {
      document.getElementById("confirmDialog").style.display = "flex";
      document.getElementById("confirmBox").dataset.type = "hard";
    }

    function cancelRestart() {
      document.getElementById("confirmDialog").style.display = "none";
    }

    function doRestart() {
      const type = document.getElementById("confirmBox").dataset.type;
      document.getElementById("confirmDialog").style.display = "none";

      if (type === "soft") {
        scores = [];
        document.getElementById("result").innerHTML = "";
        renderTable();
        renderRoundInputs();
        saveState();
      } else {
        players = [];
        scores = [];
        mode = "500";
        startPlayerIndex = null;
        localStorage.removeItem("uno_state");
        document.getElementById("setup").style.display = "block";
        document.getElementById("game").style.display = "none";
        renderNameInputs();
      }
    }
  </script>
</body>
</html>
